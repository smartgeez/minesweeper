<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Minesweeper TVAMAN</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4caf50">

<style>
:root{
  --bg:#f4f6f8; --panel:#ffffff; --accent:#ff4d4f; --text:#1e293b; --muted:#64748b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;align-items:center;justify-content:center;padding:16px}
.container{width:100%;max-width:720px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.panel{background:var(--panel);border-radius:12px;padding:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
.controls{display:flex;gap:8px;align-items:center}
.btn{border:0;padding:8px 12px;border-radius:8px;background:#0ea5a1;color:white;font-weight:600;display:inline-flex;align-items:center;gap:8px}
.btn.secondary{background:#e2e8f0;color:var(--text);font-weight:600}
.stats{display:flex;gap:8px;align-items:center}
.counter{min-width:60px;background:#111827;color:#fff;padding:6px 8px;border-radius:6px;font-weight:700;text-align:center}
.timer{min-width:60px;background:#111827;color:#fff;padding:6px 8px;border-radius:6px;font-weight:700;text-align:center}
.settings{display:flex;gap:6px;align-items:center}
.board-wrap{margin-top:12px;display:flex;justify-content:center}
.board{display:grid;touch-action:none}
.cell{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(2,6,23,0.06);background:#e6eef6;font-weight:700;color:var(--text);user-select:none;font-size:16px;border-radius:6px}
.cell.cover{background:linear-gradient(180deg,#e6eef6,#cfe7ff);cursor:pointer}
.cell.revealed{background:linear-gradient(180deg,#ffffff,#f1f5f9);cursor:default}
.cell.flag{background:linear-gradient(180deg,#fde68a,#fca5a5)}
.cell.mine{background:linear-gradient(180deg,#ffefef,#ffd6d6);color:var(--accent)}
.cell.number-1{color:#2563eb}
.cell.number-2{color:#059669}
.cell.number-3{color:#dc2626}
.cell.number-4{color:#7c3aed}
.cell.number-5{color:#b45309}
.cell.number-6{color:#0891b2}
.cell.number-7{color:#334155}
.cell.number-8{color:#0f172a}
.footer{margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.small{font-size:13px;color:var(--muted)}
.controls select,input[type=range]{padding:6px;border-radius:8px;border:1px solid rgba(2,6,23,0.06)}
.instructions{margin-top:10px;color:var(--muted);font-size:13px}
@media (max-width:520px){
  .cell{width:34px;height:34px;font-size:15px}
  .btn{padding:8px 10px}
}
</style>
</head>
<body>
<div class="container">
  <div class="header panel">
    <div>
      <div style="font-weight:800;font-size:18px">Minesweeper TVAMAN</div>
      <div class="small">Long-press to flag â€¢ Double-tap to chord</div>
    </div>
    <div class="controls">
      <div class="stats">
        <div id="mineCount" class="counter">--</div>
        <div id="time" class="timer">0s</div>
      </div>
      <button id="resetBtn" class="btn">Restart</button>
    </div>
  </div>

  <div class="panel" style="padding:12px">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div class="settings">
        <label class="small">Rows <input id="rows" type="number" value="9" min="6" max="30" style="width:64px;margin-left:6px"></label>
        <label class="small">Cols <input id="cols" type="number" value="9" min="6" max="30" style="width:64px;margin-left:6px"></label>
        <label class="small">Mines <input id="mines" type="number" value="10" min="1" max="400" style="width:84px;margin-left:6px"></label>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="sizePreset" class="btn secondary">Presets</button>
        <button id="hintBtn" class="btn secondary">Hint <span id="hintCount">3</span></button>
        <button id="safeBtn" class="btn secondary">Safe Click <span id="safeCount">2</span></button>
      </div>
    </div>

    <div class="board-wrap">
      <div id="board" class="board" role="grid" aria-label="Minesweeper board"></div>
    </div>

    <div class="instructions small">
      Controls: Tap = reveal. Long-press (hold) = toggle flag. Double-tap a revealed number to chord (reveal adjacent if flags match). Hints & safe-clicks are limited. First tap never hits a mine.
    </div>
    <div class="footer">
      <div class="small">Best times saved locally</div>
      <div style="display:flex;gap:8px">
        <select id="theme" class="small">
          <option value="default">Default</option>
          <option value="dark">Dark</option>
        </select>
        <button id="exportBtn" class="btn secondary">Export</button>
      </div>
    </div>
  </div>
</div>

<script>
// Minesweeper single-file implementation
(function(){
  const boardEl = document.getElementById('board');
  const rowsInput = document.getElementById('rows');
  const colsInput = document.getElementById('cols');
  const minesInput = document.getElementById('mines');
  const mineCountEl = document.getElementById('mineCount');
  const timeEl = document.getElementById('time');
  const resetBtn = document.getElementById('resetBtn');
  const presetBtn = document.getElementById('sizePreset');
  const hintBtn = document.getElementById('hintBtn');
  const safeBtn = document.getElementById('safeBtn');
  const hintCountEl = document.getElementById('hintCount');
  const safeCountEl = document.getElementById('safeCount');
  const themeSel = document.getElementById('theme');
  const exportBtn = document.getElementById('exportBtn');

  let rows=9,cols=9,mines=10;
  let grid=[],firstClick=true,started=false,interval=null,time=0,flags=0,hints=3,safes=2;
  let bestKey = 'ms_best_times_v1';

  function init(){
    rows = clamp(+rowsInput.value||9,6,30);
    cols = clamp(+colsInput.value||9,6,30);
    mines = clamp(+minesInput.value||10,1,Math.max(1,rows*cols-1));
    rowsInput.value = rows; colsInput.value = cols; minesInput.value = mines;
    grid = Array(rows).fill(0).map(()=>Array(cols).fill().map(()=>({revealed:false,mine:false,flag:false,adj:0,el:null})));
    firstClick = true; started=false; time=0; flags=0; hints=3; safes=2; hintCountEl.textContent=hints; safeCountEl.textContent=safes;
    mineCountEl.textContent = mines - flags;
    timeEl.textContent = '0s';
    buildBoard();
    stopTimer();
  }

  function buildBoard(){
    boardEl.innerHTML='';
    boardEl.style.gridTemplateColumns = `repeat(${cols}, minmax(36px,1fr))`;
    boardEl.style.gap='8px';
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const cell = grid[r][c];
        const el = document.createElement('div');
        el.className='cell cover';
        el.dataset.r=r; el.dataset.c=c; el.setAttribute('role','button');
        cell.el=el;
        attachEvents(el);
        boardEl.appendChild(el);
      }
    }
  }

  function attachEvents(el){
    let pressTimer=null, lastTap=0;
    const r = +el.dataset.r, c = +el.dataset.c;

    const startPress = (e)=>{
      e.preventDefault();
      pressTimer = setTimeout(()=>{ toggleFlag(r,c); pressTimer=null; }, 500); // long press ~500ms
    };
    const cancelPress = (e)=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } };

    el.addEventListener('touchstart', startPress, {passive:false});
    el.addEventListener('touchend', (e)=>{ cancelPress(e); const now = Date.now(); if(now - lastTap < 300){ // double-tap
        handleDoubleTap(r,c);
      } else {
        // schedule single tap slightly later to avoid conflict
        setTimeout(()=>{ if(!pressTimer) handleTap(r,c); }, 310);
      }
      lastTap = now;
    });

    // mouse support
    el.addEventListener('mousedown', (e)=>{ if(e.button===2) return; startPress(e); });
    el.addEventListener('mouseup', (e)=>{ cancelPress(e); const now = Date.now(); if(now - lastTap < 300){ handleDoubleTap(r,c); } else { setTimeout(()=>{ if(!pressTimer) handleTap(r,c); },310); } lastTap=now; });
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); toggleFlag(r,c); });

  }

  function handleTap(r,c){
    if(!inBounds(r,c)) return;
    if(!started){ /* do nothing */ }
    const cell = grid[r][c];
    if(cell.revealed || cell.flag) return;
    if(firstClick){ placeMines(r,c); calcAdj(); firstClick=false; startTimer(); started=true; }
    reveal(r,c);
    checkWin();
  }

  function handleDoubleTap(r,c){
    if(!inBounds(r,c)) return;
    const cell = grid[r][c];
    if(!cell.revealed) return;
    // chord: if number of adjacent flags == adj -> reveal neighbors
    const adjFlags = neighbors(r,c).filter(([rr,cc])=>grid[rr][cc].flag).length;
    if(adjFlags === cell.adj){
      neighbors(r,c).forEach(([rr,cc])=>{ if(!grid[rr][cc].flag) reveal(rr,cc); });
      checkWin();
    }
  }

  function toggleFlag(r,c){
    const cell = grid[r][c];
    if(cell.revealed) return;
    cell.flag = !cell.flag;
    flags += cell.flag?1:-1;
    cell.el.classList.toggle('flag', cell.flag);
    cell.el.classList.toggle('cover', !cell.revealed && !cell.flag);
    cell.el.textContent = cell.flag ? 'ðŸš©' : '';
    mineCountEl.textContent = Math.max(0, mines - flags);
  }

  function placeMines(skipR,skipC){
    // guarantee first click safe and open area
    const cells = [];
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) if(!(r===skipR && c===skipC)) cells.push([r,c]);
    shuffle(cells);
    for(let i=0;i<mines;i++){ const [r,c]=cells[i]; grid[r][c].mine=true; }
    // If the clicked cell had adjacent mines, optionally expand: we ensure safe-first-click by clearing that cell + flood
    if(grid[skipR][skipC].mine){ grid[skipR][skipC].mine=false; // extremely unlikely due to skip but just in case
      for(let i=mines;i<cells.length;i++){ const [r,c]=cells[i]; if(!grid[r][c].mine){ grid[r][c].mine=true; break; } }
    }
    // ensure when first clicked cell's adj >0, we can optionally shift mines to make a zero area -> simpler approach: if adj>0, relocate mines around it
    // but for simplicity, we'll flood reveal safe area after click
  }

  function calcAdj(){
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      let count=0; neighbors(r,c).forEach(([rr,cc])=>{ if(grid[rr][cc].mine) count++; });
      grid[r][c].adj = count;
    }
  }

  function reveal(r,c){
    if(!inBounds(r,c)) return; const cell=grid[r][c]; if(cell.revealed || cell.flag) return;
    cell.revealed=true; cell.el.classList.remove('cover'); cell.el.classList.add('revealed');
    if(cell.mine){ cell.el.classList.add('mine'); cell.el.textContent='ðŸ’£'; gameOver(false); return; }
    if(cell.adj>0){ cell.el.classList.add('number-'+cell.adj); cell.el.textContent = cell.adj; }
    else { cell.el.textContent=''; // flood fill
      neighbors(r,c).forEach(([rr,cc])=>{ if(!grid[rr][cc].revealed) reveal(rr,cc); }); }
  }

  function neighbors(r,c){
    const out=[]; for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ if(dr===0 && dc===0) continue; const rr=r+dr, cc=c+dc; if(inBounds(rr,cc)) out.push([rr,cc]); } return out;
  }

  function inBounds(r,c){ return r>=0 && r<rows && c>=0 && c<cols; }

  function checkWin(){
    let unrevealed=0; for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){ if(!grid[r][c].revealed) unrevealed++; }
    if(unrevealed === mines){ gameOver(true); }
  }

  function gameOver(won){ stopTimer(); revealAllMines();
    setTimeout(()=>{
      if(won){ saveBestTime(); alert('You won! Time: ' + time + 's'); } else { alert('Game over'); }
    },100);
  }

  function revealAllMines(){ for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){ const cell=grid[r][c]; if(cell.mine){ cell.revealed=true; cell.el.classList.add('revealed','mine'); cell.el.textContent='ðŸ’£'; } } }

  function startTimer(){ if(interval) clearInterval(interval); interval = setInterval(()=>{ time++; timeEl.textContent = time + 's'; },1000); }
  function stopTimer(){ if(interval) clearInterval(interval); interval=null; }

  function saveBestTime(){ const key=bestKey; const best = JSON.parse(localStorage.getItem(key)||'{}'); const id = `${rows}x${cols}_${mines}`; if(!best[id] || time < best[id]){ best[id]=time; localStorage.setItem(key, JSON.stringify(best)); }
  }

  function exportState(){ const state={rows,cols,mines,time,grid:grid.map(r=>r.map(c=>({mine:c.mine,flag:c.flag,revealed:c.revealed,adj:c.adj})))}; const blob = new Blob([JSON.stringify(state)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='minesweeper_state.json'; a.click(); URL.revokeObjectURL(url);
  }

  // helpers
  function neighborsOf(r,c){ return neighbors(r,c); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

  // hint: reveal a safe cell
  function useHint(){ if(hints<=0) return; hints--; hintCountEl.textContent=hints; // find unrevealed non-mine
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){ const cell=grid[r][c]; if(!cell.revealed && !cell.mine && !cell.flag){ reveal(r,c); return; } }
  }
  function useSafeClick(){ if(safes<=0) return; safes--; safeCountEl.textContent=safes; // highlight a safe unrevealed for a moment
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){ const cell=grid[r][c]; if(!cell.revealed && !cell.mine && !cell.flag){ const el=cell.el; el.style.outline='3px solid rgba(34,197,94,0.45)'; setTimeout(()=>el.style.outline='0',900); return; } }
  }

  // register service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("Service Worker registered"));
  }

  // wire up UI
  resetBtn.addEventListener('click', init);
  rowsInput.addEventListener('change', init); colsInput.addEventListener('change', init); minesInput.addEventListener('change', init);
  presetBtn.addEventListener('click', ()=>{
    const presets = [{r:9,c:9,m:10},{r:16,c:16,m:40},{r:16,c:30,m:99}]; let html='Choose preset:\n'; presets.forEach((p,i)=> html+=`${i+1}. ${p.r}x${p.c} - ${p.m} mines\n`); const pick = prompt(html + 'Enter 1/2/3'); const idx = Math.max(0,Math.min(presets.length-1, (parseInt(pick)-1)||0)); rowsInput.value=presets[idx].r; colsInput.value=presets[idx].c; minesInput.value=presets[idx].m; init(); });
  hintBtn.addEventListener('click', ()=>{ useHint(); }); safeBtn.addEventListener('click', ()=>{ useSafeClick(); });
  themeSel.addEventListener('change', ()=>{ if(themeSel.value==='dark'){ document.documentElement.style.setProperty('--bg','#0b1120'); document.documentElement.style.setProperty('--panel','#071428'); document.documentElement.style.setProperty('--text','#e6eef6'); document.documentElement.style.setProperty('--muted','#93c5fd'); } else { document.documentElement.style.setProperty('--bg','#f4f6f8'); document.documentElement.style.setProperty('--panel','#ffffff'); document.documentElement.style.setProperty('--text','#1e293b'); document.documentElement.style.setProperty('--muted','#64748b'); } });
  exportBtn.addEventListener('click', exportState);

  // init first
  init();

})();
</script>
</body>
</html>





